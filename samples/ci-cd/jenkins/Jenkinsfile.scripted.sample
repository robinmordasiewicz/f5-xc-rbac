// Scripted Pipeline for F5 XC User and Group Sync
// This is a sample Jenkinsfile demonstrating how to run the XC sync tool in Jenkins
// using Scripted Pipeline syntax (alternative to Declarative Pipeline)
//
// Prerequisites:
// 1. Install Python plugin or ensure Python 3.12+ is available on Jenkins agents
// 2. Configure Jenkins credentials:
//    - XC_CERT: Secret text (PEM certificate content)
//    - XC_CERT_KEY: Secret text (PEM private key content)
//    - TENANT_ID: Secret text (your F5 XC tenant ID)
// 3. Store your User-Database.csv in the repository or configure as a build parameter

properties([
    parameters([
        choice(
            name: 'SYNC_MODE',
            choices: ['dry-run', 'apply'],
            description: 'Run mode: dry-run (preview) or apply (execute changes)'
        ),
        booleanParam(
            name: 'PRUNE',
            defaultValue: false,
            description: 'Delete XC users and groups not in CSV (use with caution)'
        ),
        string(
            name: 'CSV_FILE',
            defaultValue: 'User-Database.csv',
            description: 'Path to CSV file relative to workspace'
        )
    ]),
    buildDiscarder(logRotator(numToKeepStr: '10')),
    disableConcurrentBuilds()
])

node {
    def venvDir = "${WORKSPACE}/.venv"
    def secretsDir = "${WORKSPACE}/secrets"

    try {
        timeout(time: 30, unit: 'MINUTES') {
            stage('Checkout') {
                checkout scm
                echo "Building from branch: ${env.GIT_BRANCH}"
                echo "Commit: ${env.GIT_COMMIT}"
            }

            stage('Setup Python Environment') {
                sh """
                    # Create virtual environment
                    python3 -m venv ${venvDir}

                    # Activate and upgrade pip
                    . ${venvDir}/bin/activate
                    python -m pip install --upgrade pip

                    # Install project
                    pip install -e .

                    # Verify installation
                    xc_user_group_sync --version || echo "Tool installed successfully"
                """
            }

            stage('Prepare Credentials') {
                // Create secrets directory
                sh "mkdir -p ${secretsDir}"

                // Write credentials from Jenkins secrets to files
                withCredentials([
                    string(credentialsId: 'XC_CERT', variable: 'XC_CERT_CONTENT'),
                    string(credentialsId: 'XC_CERT_KEY', variable: 'XC_CERT_KEY_CONTENT'),
                    string(credentialsId: 'TENANT_ID', variable: 'TENANT_ID_VALUE'),
                    string(credentialsId: 'XC_API_URL', variable: 'XC_API_URL_VALUE', defaultValue: '')
                ]) {
                    sh """
                        # Write certificate files
                        printf "%s" "\$XC_CERT_CONTENT" > ${secretsDir}/cert.pem
                        printf "%s" "\$XC_CERT_KEY_CONTENT" > ${secretsDir}/key.pem

                        # Set restrictive permissions
                        chmod 600 ${secretsDir}/*.pem

                        # Create .env file
                        # Use provided XC_API_URL or default to production endpoint
                        XC_API_URL_FINAL="\${XC_API_URL_VALUE:-https://\${TENANT_ID_VALUE}.console.ves.volterra.io}"
                        cat > ${secretsDir}/.env << EOF
TENANT_ID=\${TENANT_ID_VALUE}
XC_API_URL=\${XC_API_URL_FINAL}
VOLT_API_CERT_FILE=${secretsDir}/cert.pem
VOLT_API_CERT_KEY_FILE=${secretsDir}/key.pem
EOF

                        echo "Credentials prepared successfully"
                    """
                }
            }

            stage('Validate CSV') {
                def csvFile = params.CSV_FILE ?: 'User-Database.csv'

                sh """
                    if [ ! -f "${csvFile}" ]; then
                        echo "ERROR: CSV file not found: ${csvFile}"
                        exit 1
                    fi

                    echo "CSV file found: ${csvFile}"
                    wc -l ${csvFile}
                """
            }

            stage('Run Sync') {
                // Build command based on parameters (new simplified syntax)
                def syncCmd = ". ${venvDir}/bin/activate && xc_user_group_sync --csv ${params.CSV_FILE}"

                // Add dry-run flag if selected
                if (params.SYNC_MODE == 'dry-run') {
                    syncCmd += ' --dry-run'
                }

                // Add prune flag if enabled
                if (params.PRUNE) {
                    syncCmd += ' --prune'
                }

                // Add logging and retry configuration
                syncCmd += ' --log-level info --timeout 30 --max-retries 3'

                echo "Executing: ${syncCmd}"
                echo "Note: Default behavior syncs groups only. Add --sync-users for user sync."

                // Run sync
                sh syncCmd

                echo 'XC User and Group Sync completed successfully'
            }
        }
    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        echo "XC User and Group Sync failed: ${e.message}"
        throw e
    } finally {
        stage('Cleanup') {
            // Clean up secrets
            sh """
                if [ -d "${secretsDir}" ]; then
                    rm -rf ${secretsDir}
                    echo "Secrets cleaned up"
                fi
            """

            echo 'Build cleanup complete'
        }
    }
}
