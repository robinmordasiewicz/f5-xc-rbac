name: XC Group Sync

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install project
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Prepare credentials (p12 or cert/key)
        shell: bash
        env:
          XC_P12: ${{ secrets.XC_P12 }}
          XC_P12_PASSWORD: ${{ secrets.XC_P12_PASSWORD }}
          XC_CERT: ${{ secrets.XC_CERT }}
          XC_CERT_KEY: ${{ secrets.XC_CERT_KEY }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
        run: |
          set -euo pipefail
          mkdir -p secrets
          if [[ -n "${XC_CERT:-}" && -n "${XC_CERT_KEY:-}" ]]; then
            echo "$XC_CERT" | tr -d '[:space:]' | base64 -d > secrets/cert.pem
            echo "$XC_CERT_KEY" | tr -d '[:space:]' | base64 -d > secrets/key.pem
            echo "Using cert/key auth"
            echo "VOLT_API_CERT_FILE=${GITHUB_WORKSPACE}/secrets/cert.pem" >> "$GITHUB_ENV"
            echo "VOLT_API_CERT_KEY_FILE=${GITHUB_WORKSPACE}/secrets/key.pem" >> "$GITHUB_ENV"
          elif [[ -n "${XC_P12:-}" && -n "${XC_P12_PASSWORD:-}" ]]; then
            echo "$XC_P12" | tr -d '[:space:]' | base64 -d > secrets/xc.p12
            # Split p12 to PEM for requests
            openssl pkcs12 -in secrets/xc.p12 -clcerts -nokeys -out secrets/cert.pem -passin env:XC_P12_PASSWORD
            openssl pkcs12 -in secrets/xc.p12 -nocerts -nodes -out secrets/key.pem -passin env:XC_P12_PASSWORD
            # Ensure passwordless key
            if grep -q ENCRYPTED secrets/key.pem; then
              openssl rsa -in secrets/key.pem -out secrets/key_nopass.pem
              mv secrets/key_nopass.pem secrets/key.pem
            fi
            echo "Using p12 (converted to PEM) auth"
            echo "VOLT_API_CERT_FILE=${GITHUB_WORKSPACE}/secrets/cert.pem" >> "$GITHUB_ENV"
            echo "VOLT_API_CERT_KEY_FILE=${GITHUB_WORKSPACE}/secrets/key.pem" >> "$GITHUB_ENV"
          else
            echo "No XC credentials found in secrets (XC_CERT/XC_CERT_KEY or XC_P12/XC_P12_PASSWORD)." >&2
            exit 1
          fi
          if [[ -z "${TENANT_ID:-}" ]]; then
            echo "TENANT_ID secret is required" >&2
            exit 1
          fi
          echo "TENANT_ID=${TENANT_ID}" >> "$GITHUB_ENV"

      - name: Dry-run sync
        run: |
          xc-group-sync --csv ./User-Database.csv --dry-run --log-level info --timeout 30 --max-retries 3

      - name: Apply sync
        if: github.event_name == 'workflow_dispatch'
        run: |
          xc-group-sync --csv ./User-Database.csv --log-level info --timeout 30 --max-retries 3
